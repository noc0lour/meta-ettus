From 1199716fc27b692471b02bd5095193ef92293def Mon Sep 17 00:00:00 2001
From: Andrej Rode <mail@andrejro.de>
Date: Sun, 5 Nov 2017 10:48:24 +0100
Subject: [PATCH 2/3] char: xilinx_xdevcfg: Added a notifier interface

Signed-off-by: Andrej Rode <mail@andrejro.de>
---
 drivers/char/xilinx_devcfg.c | 15 +++++++++++++++
 include/linux/xdevcfg.h      |  9 +++++++++
 2 files changed, 24 insertions(+)
 create mode 100644 include/linux/xdevcfg.h

diff --git a/drivers/char/xilinx_devcfg.c b/drivers/char/xilinx_devcfg.c
index 81ee11fe7298..45983888435a 100644
--- a/drivers/char/xilinx_devcfg.c
+++ b/drivers/char/xilinx_devcfg.c
@@ -21,6 +21,7 @@
 #include <linux/kernel.h>
 #include <linux/module.h>
 #include <linux/mutex.h>
+#include <linux/notifier.h>
 #include <linux/of.h>
 #include <linux/platform_device.h>
 #include <linux/slab.h>
@@ -33,6 +34,16 @@
 #define DRIVER_NAME "xdevcfg"
 #define XDEVCFG_DEVICES 1
 
+#include <linux/xdevcfg.h>
+
+static BLOCKING_NOTIFIER_HEAD(xdevcfg_notifier_list);
+
+void xdevcfg_register_notify(struct notifier_block *nb)
+{
+	blocking_notifier_chain_register(&xdevcfg_notifier_list, nb);
+}
+EXPORT_SYMBOL_GPL(xdevcfg_register_notify);
+
 /* An array, which is set to true when the device is registered. */
 static DEFINE_MUTEX(xdevcfg_mutex);
 
@@ -527,6 +538,9 @@ static int xdevcfg_open(struct inode *inode, struct file *file)
 	drvdata->endian_swap = 0;
 	drvdata->residue_len = 0;
 
+	/* notify other drivers that registered about impending doom */
+	blocking_notifier_call_chain(&xdevcfg_notifier_list, XDEVCFG_START_RELOAD, NULL);
+
 	/*
 	 * If is_partial_bitstream is set, then PROG_B is not asserted
 	 * (xdevcfg_reset_pl function) and also zynq_slcr_init_preload_fpga and
@@ -576,6 +590,7 @@ static int xdevcfg_release(struct inode *inode, struct file *file)
 		dev_info(drvdata->dev, "Did not transfer last %d bytes\n",
 			 drvdata->residue_len);
 
+	blocking_notifier_call_chain(&xdevcfg_notifier_list, XDEVCFG_END_RELOAD, NULL);
 	drvdata->is_open = 0;
 
 	return 0;
diff --git a/include/linux/xdevcfg.h b/include/linux/xdevcfg.h
new file mode 100644
index 000000000000..310ea556e894
--- /dev/null
+++ b/include/linux/xdevcfg.h
@@ -0,0 +1,9 @@
+#ifndef _LINUX_XDEVCFG_H
+#define _LINUX_XDEVCFG_H
+
+#define XDEVCFG_START_RELOAD 0x1
+#define XDEVCFG_END_RELOAD 0x2
+
+void xdevcfg_register_notify(struct notifier_block *nb);
+
+#endif /* _LINUX_XDEVCFG_H */
-- 
2.13.6

